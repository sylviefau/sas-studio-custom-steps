{"creationTimeStamp":"2023-03-23T17:25:36.877Z","modifiedTimeStamp":"2023-03-24T14:15:06.178Z","createdBy":"sinsrn","modifiedBy":"sinsrn","name":"NLP - Train Text Classifier.step","displayName":"NLP - Train Text Classifier.step","localDisplayName":"NLP - Train Text Classifier.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","uri":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","uri":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","uri":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","uri":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","uri":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","uri":"/dataFlows/steps/a735de8d-636b-48a7-aa8a-b3977d59eb9a","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[{"name":"trainingTable","displayName":"trainingTable","localDisplayName":"trainingTable","minEntries":1,"maxEntries":1,"type":"table"},{"name":"validationTable","displayName":"validationTable","localDisplayName":"validationTable","minEntries":0,"maxEntries":1,"type":"table"},{"name":"testTable","displayName":"testTable","localDisplayName":"testTable","minEntries":0,"maxEntries":1,"type":"table"}],"outputPorts":[{"name":"modelOut","displayName":"modelOut","localDisplayName":"modelOut","minEntries":1,"maxEntries":1,"type":"table","supportsView":false,"requiresStructure":false}]},"ui":"{\"showPageContentOnly\":true,\"pages\":[{\"id\":\"parameters\",\"type\":\"page\",\"label\":\"Parameters\",\"children\":[{\"id\":\"trainingTable\",\"type\":\"inputtable\",\"label\":\"Training table:\",\"required\":true,\"placeholder\":\"\",\"visible\":\"\"},{\"id\":\"validationTable\",\"type\":\"inputtable\",\"label\":\"Validation table:\",\"required\":false,\"placeholder\":\"\",\"visible\":\"\"},{\"id\":\"testTable\",\"type\":\"inputtable\",\"label\":\"Test table:\",\"required\":false,\"placeholder\":\"\",\"visible\":\"\"},{\"id\":\"section1\",\"type\":\"section\",\"label\":\"Input parameters\",\"open\":true,\"visible\":\"\",\"children\":[{\"id\":\"textVar\",\"type\":\"columnselector\",\"label\":\"Select text variable:\",\"order\":false,\"columntype\":\"a\",\"max\":1,\"min\":1,\"visible\":\"\",\"table\":\"trainingTable\"},{\"id\":\"targetVar\",\"type\":\"columnselector\",\"label\":\"Select target variable:\",\"order\":false,\"columntype\":\"a\",\"max\":1,\"min\":1,\"visible\":\"\",\"table\":\"trainingTable\"},{\"id\":\"gpuEnabled\",\"type\":\"checkbox\",\"label\":\"Enable GPU\",\"visible\":\"\"},{\"id\":\"numDevices\",\"type\":\"numberfield\",\"label\":\"Specify GPU device ID (max 1):\",\"placeholder\":\"\",\"required\":false,\"max\":null,\"min\":null,\"visible\":\"$gpuEnabled\"},{\"id\":\"advancedParam\",\"type\":\"section\",\"label\":\"Advanced parameters\",\"open\":true,\"visible\":\"\",\"children\":[{\"id\":\"batchSize\",\"type\":\"numberfield\",\"label\":\"Batch size:\",\"placeholder\":\"\",\"required\":false,\"max\":32,\"min\":1,\"excludemin\":false,\"excludemax\":false,\"visible\":\"\"},{\"id\":\"chunkSize\",\"type\":\"numberfield\",\"label\":\"Chunk size:\",\"placeholder\":\"\",\"required\":false,\"max\":512,\"min\":4,\"excludemin\":false,\"excludemax\":false,\"visible\":\"\"},{\"id\":\"maxEpochs\",\"type\":\"numberfield\",\"label\":\"Maximum epochs:\",\"placeholder\":\"\",\"required\":false,\"max\":100000000,\"min\":1,\"excludemin\":false,\"excludemax\":false,\"visible\":\"\"},{\"id\":\"seedNumber\",\"type\":\"numberfield\",\"label\":\"Seed:\",\"placeholder\":\"\",\"required\":false,\"max\":2147483646,\"min\":0,\"excludemin\":false,\"excludemax\":false,\"visible\":\"\"},{\"id\":\"validationPartitionFraction\",\"type\":\"numberfield\",\"label\":\"Validation partition fraction:\",\"placeholder\":\"\",\"required\":false,\"max\":0.95,\"min\":0,\"excludemin\":false,\"excludemax\":false,\"visible\":\"\"}]}]},{\"id\":\"modelOut\",\"type\":\"outputtable\",\"label\":\"Model output table:\",\"required\":true,\"placeholder\":\"\",\"visible\":\"\"}]},{\"id\":\"about\",\"type\":\"page\",\"label\":\"About\",\"children\":[{\"id\":\"about_text\",\"type\":\"text\",\"text\":\"NLP - Train Text Classifier\\n\\nThis custom step enables you to train a text classifier model based on deep learning (BERT-based transformer) architecture.\\n\\nIt uses the recently introduced SAS Visual Text Analytics (VTA) CAS action, textClassifier.trainTextClassifier.  This augments SAS approaches for Natural Language Processing-based classification models (in addition to rules-based classification). More details in the documentation (link provided below).\\n\\nUse this to train models which can classify customer reviews as per a star rating, carry out sentiment analysis, prioritize customer complaints, identify serious adverse events, and many other classification use-cases.\\n\\nUse of this custom step requires a SAS Visual Text Analytics (VTA) license.\\n \\nParameters:\\n\\nNote that this custom step runs on data loaded in SAS Cloud Analytics Services (CAS). Ensure you are connected to CAS before running this step.\\n\\nInput parameters:\\n\\n1. Input ports: connect CAS tables to the training table, validation table, and test table input ports.  At the minimum, a training table is required.\\n\\n2. Text variable: select a variable containing the text you wish to train a classifier upon.  Ensure you select either a char or varchar variable.\\n\\n3. Target variable: select a column containing the labelled target for which you wish to train a classifier. \\n\\n4. Enable GPU: choose between using GPU or CPU resources to train your model.  GPUs are recommended due to their performant nature.  At the same time, note that GPUs may not be readily available in all Viya environments, and may lead to higher cloud costs.  Check with your SAS administrator on the availability of GPU resources.\\n\\n5. As an optional step, if you select Enable GPU, you may choose to provide the device ID of the GPU you wish to use.  Currently, the action allows for only 1 GPU device to be used.\\n\\n6. Advanced parameters: you might like to modify hyperparameters governing the training process by changing provided default values.  Note this will affect speed and accuracy of your model.  It's suggested that you refer documentation (below) for more details.\\n\\nOutput table specifications:\\n\\n- Output port: connect an output CAS table to contain the trained model.  Note that the output model is binary data which is not human-readable.\\n\\nDocumentation:\\n\\n- The textClassifier.trainTextClassifier CAS action : https://go.documentation.sas.com/doc/en/pgmsascdc/default/casvtapg/cas-textclassifier-traintextclassifier.htm\\n\\nCreated / contact : \\n\\n- Sundaresh Sankaran (sundaresh.sankaran@sas.com)\\n\\nVersion : 1.0.   (18MAR2023)\",\"visible\":\"\"}]}],\"values\":{\"trainingTable\":{\"library\":\"\",\"table\":\"\"},\"validationTable\":{\"library\":\"\",\"table\":\"\"},\"testTable\":{\"library\":\"\",\"table\":\"\"},\"textVar\":[],\"targetVar\":[],\"gpuEnabled\":false,\"numDevices\":null,\"batchSize\":16,\"chunkSize\":256,\"maxEpochs\":4,\"seedNumber\":0,\"validationPartitionFraction\":0.05,\"modelOut\":{\"library\":\"\",\"table\":\"\"}},\"syntaxversion\":\"1.3.0\"}","templates":{"SAS":"/* SAS templated code goes here */\n\n/*--------------------------------------------------------------------------------------*\n   This macro creates a global macro variable called _usr_nameCaslib\n   that contains the caslib name (aka. caslib-reference-name) associated with the libname \n   and assumes that the libname is using the CAS engine.\n\n   As sysvalue has a length of 1024 chars, we use the trimmed option in proc sql\n   to remove leading and trailing blanks in the caslib name.\n*---------------------------------------------------------------------------------------*/\n\n%macro _usr_getNameCaslib(_usr_LibrefUsingCasEngine); \n\n   %global _usr_nameCaslib;\n   %let _usr_nameCaslib=;\n\n   proc sql noprint;\n      select sysvalue into :_usr_nameCaslib trimmed from dictionary.libnames\n      where libname=upcase(\"&_usr_LibrefUsingCasEngine.\") and upcase(sysname)=\"CASLIB\";\n   quit;\n\n%mend _usr_getNameCaslib;\n\n\n/*--------------------------------------------------------------------------------------*\n   Macro to execute string substitution for \"GPU Devices\" in case the user enables GPU & \n   specifies a GPU device ID. \n\n   Note : For those interested, a little dated but insightful SAS Global Forum paper on \n   the best way to evaluate if a macro variable is blank (as used below), provided here:\n   http://support.sas.com/resources/papers/proceedings09/022-2009.pdf \n*---------------------------------------------------------------------------------------*/\n\n%macro gpu_status_string_substitute;\n   %global deviceArgumentString;\n   %if &gpuEnabled.=0 %then %do;\n      %let deviceArgumentString=;\n   %end;\n   %else %do;\n      %if %sysevalf(%superq(numDevices)=,boolean) %then %do;\n         %let deviceArgumentString=;\n      %end;\n      %else %do;\n         data _null_;\n            call symput(\"deviceArgumentString\",\",device=&numDevices.\");\n         run;\n      %end;\n   %end;\n\n%mend gpu_status_string_substitute;\n\n\n/*--------------------------------------------------------------------------------------*\n  Call the above \"caslib check\" macro 4 times for each of the tables (and their libnames) \n  presently connected to this step.\n*---------------------------------------------------------------------------------------*/\n\n%_usr_getNameCaslib(&trainingTable_lib.);\n%let training_table_lib=&_usr_nameCaslib.;\n\n%if \"&training_table_lib.\"=\"\" %then %do;\n   %put NOTE: Please provide a valid table and libref using the CAS engine.;\n   data _null_;\n      abort exit 4321;\n   run;\n%end;\n\n%_usr_getNameCaslib(&validationTable_lib.);\n%let validation_table_lib=&_usr_nameCaslib.;\n\n%_usr_getNameCaslib(&testTable_lib.);\n%let test_table_lib=&_usr_nameCaslib.;\n\n%_usr_getNameCaslib(&modelOut_lib.);\n%let model_table_lib=&_usr_nameCaslib.;\n\n/* Blank out the _usr_nameCaslib macro variable so as to not leave things dangling. */\n%let _usr_nameCaslib=;\n\n\n/* Execute the gpu_status_string_substitute macro. */\n\n%gpu_status_string_substitute;\n\n\n/* Main Processing occurs in the below section through a CAS action call.  */\n\nproc cas;\n\n/* Obtain values from the UI */\n   training_table_name=symget(\"trainingTable_name_base\");\n   training_table_lib=symget(\"training_table_lib\");\n   model_table_name=symget(\"modelOut_name_base\");\n   model_table_lib=symget(\"model_table_lib\");\n   target_variable=symget(\"targetVar_1_name_base\");\n   text_variable=symget(\"textVar_1_name_base\");\n   validation_table_name=symget(\"validationTable_name_base\");\n   validation_table_lib=symget(\"validation_table_lib\");\n   test_table_name=symget(\"testTable_name_base\");\n   test_table_lib=symget(\"test_table_lib\");\n\n   print(\"Your model will be written to \"||model_table_lib||\".\"||model_table_name);\n   print(\"Your training table is \"||training_table_lib||\".\"||training_table_name);\n\n/* Repurpose training table as validation, if validation table not provided */\n   if validation_table_name=\"\" then do; \n      print(\"No validation table specified.  Using training table for validation.\");\n      validation_table_name=training_table_name;\n      validation_table_lib=training_table_lib;\n   end;\n\n/* Repurpose training table as test, if test table not provided. */\n   if test_table_name=\"\" then do; \n      print(\"No test table specified.  Using training table for test.\");\n      test_table_name=training_table_name;\n      test_table_lib=training_table_lib;\n   end;    \n\n/* Train a text classifier for the given target variable */\n   textClassifier.trainTextClassifier /               \n      table={name=training_table_name, caslib=training_table_lib}\n      modelOut={name=model_table_name, caslib=model_table_lib, replace=True}\n      target=target_variable\n      text=text_variable\n      gpu={enable=&gpuEnabled. &deviceArgumentString.}\n      batchSize=&batchSize.\n      chunkSize=&chunkSize.\n      maxEpochs=&maxEpochs.\n      seed=&seedNumber.\n      testTable={name=test_table_name, caslib=test_table_lib}\n      validationPartitionFraction=&validationPartitionFraction.\n      validTable={name=validation_table_name, caslib=validation_table_lib}\n;\n\n/* Future placeholder : Persist Model Table */\n\nquit;  "}}